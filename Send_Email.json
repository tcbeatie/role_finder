{
  "name": "Send Email v2.1",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "bb7b0ff1-413c-4385-a6d1-6fe60e5d0962",
      "name": "Start",
      "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  NODE 1: WORKFLOW TRIGGER (EMAIL WORKFLOW ENTRY POINT)  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  This is the entry point for the Email workflow.\n\n  What data arrives here:\n  When called from parent workflow, receives:\n\n  - workflow_run_id (CRITICAL):\n    - Parent workflow's execution ID\n    - Example: 67890\n    - Used to query email_queue table\n    - Links to all jobs processed in parent workflow run\n    - This is THE KEY that ties the entire\n      system together\n\n  - companies_processed (optional):\n    - Summary count from parent workflow\n    - Example: 40\n    - For logging/debugging\n    - Not used in email generation\n\n  - query_timestamp (optional):\n    - When parent workflow completed\n    - Example: \"2025-12-29T14:30:00.000Z\"\n    - For audit trail and debugging\n\n  Data flow summary with example:\n\n  Loop Companies starts â†’ execution_id = 67890\n  (becomes workflow_run_id)\n    â†“\n    â”œâ”€ Company 1: Anthropic\n    â”‚  â””â”€ Loop Jobs called with\n    â”‚     _context_workflow_run_id = 67890\n    â”‚     â”œâ”€ Job 1: Senior PM â†’ AI eval â†’\n    â”‚        email_queue (workflow_run_id: 67890)\n    â”‚     â”œâ”€ Job 2: Lead PM â†’ AI eval â†’\n    â”‚        email_queue (workflow_run_id: 67890)\n    â”‚     â””â”€ Job 8: Principal PM â†’ AI eval â†’\n    â”‚        email_queue (workflow_run_id: 67890)\n    â”‚\n    â”œâ”€ Company 2: OpenAI\n    â”‚  â””â”€ Loop Jobs called with\n    â”‚     _context_workflow_run_id = 67890\n    â”‚     â”œâ”€ Job 1: Technical PM â†’ AI eval â†’\n    â”‚        email_queue (workflow_run_id: 67890)\n    â”‚     â””â”€ Job 5: Staff PM â†’ AI eval â†’\n    â”‚        email_queue (workflow_run_id: 67890)\n    â”‚\n    â””â”€ All companies done (40 total)\n       â””â”€ Workflow Summary node:\n          { workflow_run_id: 67890 }\n          â””â”€ Triggers Send Email workflow\n             (THIS WORKFLOW)\n             â†“\n             Load Email Queue: WHERE\n             workflow_run_id = 67890\n             Result: All 13 jobs (8 from Anthropic\n             + 5 from OpenAI)\n             â†“\n             Aggregate and Sort: Order by\n             overall_score DESC\n             â†“\n             Build Email: Generate HTML with\n             summary stats\n             â†“\n             Send Jobs Email: Gmail delivery â†’\n             User inbox\n\n  Critical note on workflow_run_id:\n\n  The workflow_run_id is THE MASTER KEY that\n  connects everything:\n\n  1. CREATED BY: Loop Companies workflow (its\n     $execution.id)\n  2. PROPAGATED TO: Every job via\n     _context_workflow_run_id\n  3. STORED IN: email_queue table with every job card\n  4. PASSED TO: This email workflow for querying\n  5. RESULT: Single query retrieves all jobs\n     from entire daily run\n\n  Next node: Load Email Queue"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "8Z8MLvTvK4YX7SuB",
          "mode": "list",
          "cachedResultName": "Email_Queue",
          "cachedResultUrl": "/projects/NRVzB7ls7lOjZ60v/datatables/8Z8MLvTvK4YX7SuB"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "workflow_run_id",
              "keyValue": "={{ $json.workflow_run_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1.1,
      "position": [
        208,
        0
      ],
      "id": "a1fe9fab-51b4-478b-b52f-d2a1210b4a07",
      "name": "Load Email Queue",
      "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  NODE 2: LOAD EMAIL QUEUE FROM DATABASE  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  Queries the email_queue table to retrieve all\n  jobs processed in the current workflow run.\n\n  What this node does:\n  - Connects to n8n data table: \"email_queue\"\n  - Filters by workflow_run_id from parent\n    workflow (or manual trigger)\n  - Returns ALL jobs across ALL companies from\n    this workflow run\n  - Each row is one complete job with HTML card\n    and metadata\n\n  Table schema (columns stored):\n\n  1. workflow_run_id (number):\n     - PRIMARY FILTER FIELD (indexed for\n       performance)\n     - Groups all jobs from single workflow run\n     - Example: 67890\n     - This is how we know which jobs belong together\n\n  2. recommendation (string):\n     - AI's recommendation category\n     - Values: EXCELLENT_MATCH | GOOD_MATCH |\n       CONSIDER | POOR_FIT | REJECT\n     - Used for filtering and grouping in next node\n     - Determines badge color in email\n\n  3. overall_score (number):\n     - AI's numeric score (1-10)\n     - Primary sort field (higher = better match)\n     - Used to order jobs in email (best first)\n\n  4. html_card (string):\n     - Complete, formatted HTML job card\n     - Self-contained, ready to insert in email\n     - Generated by Loop Jobs workflow's Format\n       Job Card node\n     - Size: ~2-5KB per job\n     - Contains: title, company, salary,\n       location, AI assessment, scores\n\n  5. job_id (string):\n     - Unique identifier from Apify\n     - Links back to raw jobs_test_1 table\n     - Used for deduplication and tracking\n\n  6. company_name (string):\n     - Company posting the job\n     - Example: \"Anthropic\", \"OpenAI\", \"Google\"\n     - Could be used for company-based grouping\n       (not currently used)\n\n  7. job_title (string):\n     - Job title for reference\n     - Example: \"Senior Technical Product Manager\"\n     - Stored separately for quick reference\n       without parsing HTML\n\n  Next node receives:\n  - Array of job objects\n  - Each with html_card field\n  - Each with scoring metadata\n  - Ready for aggregation and sorting\n\n  Next node: Aggregate and Sort Jobs"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NODE 3: AGGREGATE AND SORT JOBS\n// Purpose: Organize jobs by score and category for optimal email presentation\n// ============================================================================\n\n// STEP 1: Get all jobs from database query\n// $input.all() returns array of ALL items from Load Email Queue node\nconst allJobs = $input.all();\n// Example: 20 items (jobs) from email_queue table\n\n// ============================================================================\n// CATEGORIZATION\n// Group jobs by AI recommendation for statistics\n// ============================================================================\n\n// EXCELLENT_MATCH: Top-tier jobs - perfect fit across all dimensions\nconst excellentMatches = allJobs.filter(job => job.json.recommendation === 'EXCELLENT_MATCH');\n// Example: 3 jobs\n\n// GOOD_MATCH: Strong candidates - good fit with minor gaps\n// NOTE: Original code uses 'STRONG_MATCH' but AI returns 'GOOD_MATCH'\n// Keeping both for compatibility\nconst strongMatches = allJobs.filter(job => \n  job.json.recommendation === 'STRONG_MATCH' || \n  job.json.recommendation === 'GOOD_MATCH'\n);\n// Example: 8 jobs\n\n// CONSIDER: Possible matches - worth reviewing despite gaps\nconst considerJobs = allJobs.filter(job => job.json.recommendation === 'CONSIDER');\n// Example: 6 jobs\n\n// POOR_FIT: Not recommended - significant mismatches\nconst poorFits = allJobs.filter(job => job.json.recommendation === 'POOR_FIT');\n// Example: 3 jobs\n\n// ============================================================================\n// SORTING\n// Primary sort: overall_score descending (best jobs first)\n// ============================================================================\n\nconst sortedJobs = allJobs.sort((a, b) => \n  b.json.overall_score - a.json.overall_score\n);\n// Result: Jobs ordered 10 â†’ 9 â†’ 9 â†’ 8 â†’ 7 â†’ ...\n// Best matches appear at top of email\n\n// Alternative sorting strategies (not currently used):\n// 1. Sort by recommendation then score:\n//    - All EXCELLENT_MATCH first, then GOOD_MATCH, etc.\n//    - Within each category, sort by score\n// 2. Sort by company then score:\n//    - Group by company_name\n//    - Within each company, sort by score\n// 3. Sort by date_posted then score:\n//    - Newest jobs first\n//    - Within same date, sort by score\n\n// ============================================================================\n// HTML CARD CONCATENATION\n// Combine individual job cards into single HTML block\n// ============================================================================\n\nconst jobCardsHtml = sortedJobs\n  .map(job => job.json.html_card)  // Extract html_card field from each job\n  .join('\\n<div style=\"margin: 20px 0;\"></div>\\n');  // Add spacer between cards\n\n// WHAT THIS DOES:\n// Takes: Array of 20 job objects with html_card fields\n// \n// Step 1 - .map(): Extract just the HTML cards\n// [\n//   \"<div style=\\\"...\\\">Job 1 card HTML</div>\",\n//   \"<div style=\\\"...\\\">Job 2 card HTML</div>\",\n//   ...\n// ]\n// \n// Step 2 - .join(): Concatenate with spacer\n// \"<div>Job 1</div>\\n<div style=\\\"margin: 20px 0;\\\"></div>\\n<div>Job 2</div>...\"\n// \n// Result: Single string with all job cards and visual spacing\n\n// WHY ADD SPACERS?\n// - Visual separation between job cards\n// - 20px vertical margin provides breathing room\n// - Prevents cards from looking cramped\n// - Improves email readability\n\n// ============================================================================\n// VALIDATION CHECK (Optional - could add)\n// ============================================================================\n\n// Could add validation:\n// if (allJobs.length === 0) {\n//   throw new Error('No jobs found in email queue for this workflow_run_id');\n// }\n\n// ============================================================================\n// OUTPUT STRUCTURE\n// Create single aggregated object with statistics and HTML\n// ============================================================================\n\nreturn [{\n  json: {\n    // === SUMMARY COUNTS ===\n    // These drive the email header statistics and subject line\n    total_jobs: allJobs.length,  // 20\n    excellent_count: excellentMatches.length,  // 3\n    strong_count: strongMatches.length,  // 8\n    consider_count: considerJobs.length,  // 6\n    poor_count: poorFits.length,  // 3\n    \n    // === COMPLETE HTML CONTENT ===\n    // All job cards concatenated with spacers, sorted by score\n    job_cards_html: jobCardsHtml,\n    // ~100KB of HTML for 20 jobs\n    \n    // === WORKFLOW TRACKING ===\n    // Preserve workflow_run_id for email footer and debugging\n    workflow_run_id: allJobs[0].json.workflow_run_id\n    // Safe to access [0] because we know we have jobs from query\n  }\n}];\n\n// WHAT GETS OUTPUT:\n// Single item (not 20) with aggregated data:\n// {\n//   total_jobs: 20,\n//   excellent_count: 3,\n//   strong_count: 8,\n//   consider_count: 6,\n//   poor_count: 3,\n//   job_cards_html: \"<div>...</div><spacer><div>...</div>...\",\n//   workflow_run_id: 67890\n// }\n\n// WHY CONSOLIDATE TO SINGLE ITEM?\n// Before this node:\n// - Load Email Queue returns 20 separate items (one per job)\n// - Each item is a complete job object\n// \n// After this node:\n// - Returns 1 single item with aggregated data\n// - Includes counts and combined HTML\n// \n// Benefits:\n// 1. Simplifies email generation (next node)\n// 2. Counts already calculated\n// 3. HTML already sorted and combined\n// 4. Build Email node just inserts values into template\n\n// EXAMPLE EMAIL SUBJECT LINE (next node generates):\n// \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n// These numbers come from excellent_count, strong_count, total_jobs\n\n// EXAMPLE EMAIL BODY (next node generates):\n// [Header with summary stats]\n// [Job card 1 - score 10]\n// <spacer>\n// [Job card 2 - score 9]\n// <spacer>\n// [Job card 3 - score 9]\n// ...\n// [Footer]\n\n// POTENTIAL ENHANCEMENTS:\n// Could add more sophisticated sorting:\n// 1. Group by company:\n//    const jobsByCompany = {};\n//    allJobs.forEach(job => {\n//      const company = job.json.company_name;\n//      if (!jobsByCompany[company]) jobsByCompany[company] = [];\n//      jobsByCompany[company].push(job);\n//    });\n//    \n// 2. Filter by score threshold:\n//    const topJobs = sortedJobs.filter(job => job.json.overall_score >= 7);\n//    \n// 3. Add company counts:\n//    const companies = [...new Set(allJobs.map(j => j.json.company_name))];\n//    companies_count: companies.length\n\n// ARCHITECTURAL NOTE:\n// This node transforms:\n// - Many items (job objects) â†’ One item (aggregated summary)\n// - Individual job cards â†’ Combined HTML string\n// - Raw data â†’ Presentation-ready data\n// \n// This pattern is common in data aggregation workflows:\n// Query â†’ Individual results â†’ Aggregate â†’ Single summary\n\n// Next node: Build Email\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        0
      ],
      "id": "2ce5ea78-ae1a-48c7-b743-7192776c82f0",
      "name": "Aggregate and Sort Jobs",
      "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  NODE 3: AGGREGATE AND SORT JOBS\n  Purpose: Organize jobs by score and category\n  for optimal email presentation  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ARCHITECTURAL NOTE:\n  This node transforms the data structure from:\n  - MANY ITEMS (20 individual jobs) â†’ ONE ITEM\n    (aggregated summary)\n  - Individual job cards â†’ Combined HTML string\n  - Raw data â†’ Presentation-ready data\n\n  STEP 1: Get all jobs from database query\n  $input.all() returns array of ALL items from\n  Load Email Queue node\n  Example: 20 items (jobs) from email_queue table\n  Each item: { json: { workflow_run_id,\n  recommendation, overall_score, html_card, ... } }\n\n â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  CATEGORIZATION\n  Group jobs by AI recommendation for summary statistics\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  EXCELLENT_MATCH: Top-tier jobs - perfect fit\n  across all dimensions\n  Seniority + Domain + Technical Depth +\n  Location + Compensation all high\n  const excellentMatches = allJobs.filter(job =>\n    job.json.recommendation === 'EXCELLENT_MATCH');\n  Example: 3 jobs with scores 9-10\n\n  GOOD_MATCH / STRONG_MATCH: Strong candidates -\n  good fit with minor gaps\n  NOTE: AI prompt uses 'GOOD_MATCH' but checking\n  both for compatibility\n  One or two dimensions slightly lower but overall strong fit\n  const strongMatches = allJobs.filter(job =>\n    job.json.recommendation === 'STRONG_MATCH' ||\n    job.json.recommendation === 'GOOD_MATCH' );\n\n  CONSIDER: Possible matches - worth reviewing despite notable gaps\n  Multiple dimensions are acceptable but not strong\n  User should review carefully before applying\n  const considerJobs = allJobs.filter(job =>\n    job.json.recommendation === 'CONSIDER');\n\n  POOR_FIT: Not recommended - significant mismatches\n  Multiple critical dimensions fail (wrong level, location, domain)\n  Included for completeness but not highlighted  in email\n  const poorFits = allJobs.filter(job =>\n    job.json.recommendation === 'POOR_FIT');\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  SORTING\n  Primary sort: overall_score descending (best jobs first)\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  Sort by score: highest to lowest\n  This ensures best matches appear at top of email\n  User sees most relevant jobs first without scrolling\n  const sortedJobs = allJobs.sort((a, b) =>\n    b.json.overall_score - a.json.overall_score\n  );\n  Result: Jobs ordered 10 â†’ 9 â†’ 9 â†’ 8 â†’ 8 â†’ 7 â†’\n  7 â†’ 6 â†’ ...\n  Best matches appear at top of email digest\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  HTML CARD CONCATENATION\n  Combine individual job cards into single HTML block ready for email\n â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  const jobCardsHtml = sortedJobs\n    .map(job => job.json.html_card)\n    .join('\\n<div style=\"margin: 20px\n      0;\"></div>\\n');\n\n  WHAT THIS DOES (step by step):\n\n  STEP 1 - .map(job => job.json.html_card):\n  Extract just the HTML card strings from each job object\n  Input: [\n    { json: { html_card: \"<div>Job 1\n      HTML</div>\", ... } },\n    { json: { html_card: \"<div>Job 2\n      HTML</div>\", ... } },\n    ...\n  ]\n  Output: [\n    \"<div>Job 1 HTML</div>\",\n    \"<div>Job 2 HTML</div>\",\n    ...\n  ]\n\n  STEP 2 - .join('\\n<div style=\"margin: 20px\n  0;\"></div>\\n'):\n  Concatenate all HTML cards with visual spacer between each\n  The spacer creates 20px vertical space between cards\n  \\n adds newlines for readable HTML source (not visible to user)\n\n  Output (conceptual):\n  \"<div>Job 1 HTML</div>\n   <div style=\"margin: 20px 0;\"></div>\n   <div>Job 2 HTML</div>\n   <div style=\"margin: 20px 0;\"></div>\n   <div>Job 3 HTML</div>\n   ...\"\n\n  Result: Single string with all job cards and visual spacing\n  Size: ~40-100KB for 20 jobs (2-5KB per card)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  OUTPUT STRUCTURE\n  Create single aggregated object with statistics and combined HTML\n â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  return [{\n    json: {\n      // === SUMMARY COUNTS ===\n      // These drive the email header statistics\n      // and dynamic subject line\n      total_jobs: allJobs.length,  // 20 - Total\n        jobs in digest\n      excellent_count: excellentMatches.length,\n        // 3 - Best matches\n      strong_count: strongMatches.length,  // 8 -\n        Good matches\n      consider_count: considerJobs.length,  // 6\n        - Review carefully\n      poor_count: poorFits.length,  // 3 - Not\n        recommended\n\n      // === COMPLETE HTML CONTENT ===\n      // All job cards concatenated with spacers,\n      // sorted by score\n      job_cards_html: jobCardsHtml,\n      // Size: ~40-100KB for 20 jobs\n      // Contains: Complete, formatted HTML ready\n      // to insert into email body\n\n      // === WORKFLOW TRACKING ===\n      // Preserve workflow_run_id for email\n      // footer and debugging\n      workflow_run_id:\n        allJobs[0].json.workflow_run_id\n      // Safe to access [0] because we know we\n      // have jobs from query\n      // All jobs have same workflow_run_id anyway\n    }\n  }];\n\n  WHAT GETS OUTPUT:\n  Single item (not 20) with aggregated data:\n  {\n    total_jobs: 20,\n    excellent_count: 3,\n    strong_count: 8,\n    consider_count: 6,\n    poor_count: 3,\n    job_cards_html: \"<div>...</div><spacer>\n      <div>...</div>...\",\n    workflow_run_id: 67890\n  }\n\n  EXAMPLE EMAIL SUBJECT LINE (next node\n  generates):\n  \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n  These numbers come from: excellent_count,\n  strong_count, total_jobs\n\n  EXAMPLE EMAIL BODY STRUCTURE (next node\n  generates):\n  [Header with date and branding]\n  [Summary statistics: 3 excellent, 8 strong, 6\n  consider, 20 total]\n  [Highlight banner if excellent_count > 0]\n  [Job card 1 - score 10] â† Best match first\n  <spacer>\n  [Job card 2 - score 9]\n  <spacer>\n  [Job card 3 - score 9]\n  ...\n  [Job card 20 - score 4] â† Lowest match last\n  [Footer with workflow_run_id]\n\n  PERFORMANCE NOTES:\n  - Array operations (filter, sort, map) are fast for <1000 items\n  - Typical: 20-200 jobs, completes in <10ms\n  - String concatenation with join() is efficient\n  - No database queries, all in-memory processing\n\n  Next node: Build Email"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NODE 4: BUILD EMAIL (HTML EMAIL GENERATOR)\n// Purpose: Create professional, responsive HTML email with job digest\n// ============================================================================\n\n// STEP 1: Get aggregated data from previous node\n// Previous node consolidated 20 jobs into single item with statistics\nconst data = $input.first().json;\n// .first() gets the single aggregated item\n// .json extracts the data object\n\n// STEP 2: Destructure all the statistics and content\nconst {\n  total_jobs,           // 20 - Total jobs in this digest\n  excellent_count,      // 3 - Excellent matches\n  strong_count,         // 8 - Good/Strong matches\n  consider_count,       // 6 - Consider reviewing\n  poor_count,          // 3 - Poor fits\n  job_cards_html,      // Combined HTML of all job cards\n  workflow_run_id      // 67890 - Workflow tracking ID\n} = data;\n\n// ============================================================================\n// DYNAMIC SUBJECT LINE GENERATION\n// Creates attention-grabbing subject based on job quality distribution\n// ============================================================================\n\n// Build subject line parts dynamically\nlet subjectParts = [];\n\n// Prioritize excellent matches\nif (excellent_count > 0) {\n  subjectParts.push(`${excellent_count} Excellent Match${excellent_count !== 1 ? 'es' : ''}`);\n  // Examples: \"1 Excellent Match\", \"3 Excellent Matches\"\n}\n\n// Add strong matches if present\nif (strong_count > 0) {\n  subjectParts.push(`${strong_count} Strong`);\n  // Examples: \"8 Strong\"\n}\n\n// Only mention \"consider\" if no excellent or strong matches\nif (consider_count > 0 && excellent_count === 0 && strong_count === 0) {\n  subjectParts.push(`${consider_count} to Consider`);\n  // Only shown if digest is entirely \"consider\" level jobs\n}\n\n// Assemble final subject line\nconst subject = subjectParts.length > 0\n  ? `ğŸ¯ ${subjectParts.join(', ')} â€¢ ${total_jobs} Total Jobs`\n  : `ğŸ“Š ${total_jobs} New Job${total_jobs !== 1 ? 's' : ''} to Review`;\n\n// Example subject lines:\n// - \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\" (good day)\n// - \"ğŸ¯ 2 Excellent Matches â€¢ 5 Total Jobs\" (fewer jobs, high quality)\n// - \"ğŸ“Š 3 New Jobs to Review\" (no excellent/strong matches)\n// - \"ğŸ“Š 1 New Job to Review\" (singular grammar)\n\n// WHY DYNAMIC SUBJECTS?\n// - Immediate attention to excellent matches\n// - User can triage email priority from inbox\n// - Excitement for good days (\"3 Excellent Matches!\")\n// - Professional tone for normal days\n\n// ============================================================================\n// DATE FORMATTING\n// Display current date in email header\n// ============================================================================\n\nconst today = new Date();\nconst formattedDate = today.toLocaleDateString('en-US', { \n  weekday: 'long',      // \"Monday\"\n  year: 'numeric',      // \"2025\"\n  month: 'long',        // \"December\"\n  day: 'numeric'        // \"29\"\n});\n// Result: \"Monday, December 29, 2025\"\n\n// ============================================================================\n// HTML EMAIL TEMPLATE\n// Professional, responsive design optimized for email clients\n// ============================================================================\n\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Daily Job Digest</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\">\n  \n  <!-- Email Container: 700px max width for readability -->\n  <div style=\"max-width: 700px; margin: 0 auto; padding: 20px;\">\n    \n    <!-- ================================================ -->\n    <!-- EMAIL HEADER -->\n    <!-- Purple gradient banner with title and date -->\n    <!-- ================================================ -->\n    <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 24px; border-radius: 12px 12px 0 0; margin-bottom: 0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n      <h1 style=\"margin: 0 0 8px 0; color: #ffffff; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">\n        ğŸ¯ Your Daily Job Digest\n      </h1>\n      <p style=\"margin: 0; color: rgba(255, 255, 255, 0.9); font-size: 15px;\">\n        ${formattedDate}\n      </p>\n    </div>\n    \n    <!-- ================================================ -->\n    <!-- SUMMARY STATISTICS CARD -->\n    <!-- Four-column grid showing job counts by category -->\n    <!-- ================================================ -->\n    <div style=\"background: #ffffff; padding: 24px; border-radius: 0 0 12px 12px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n      \n      <!-- Four-column responsive grid -->\n      <div style=\"display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;\">\n        \n        <!-- EXCELLENT MATCHES - Green theme -->\n        <div style=\"padding: 16px 8px; background: ${excellent_count > 0 ? '#f0fdf4' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${excellent_count > 0 ? '#10b981' : '#e5e7eb'};\">\n          <div style=\"color: #10b981; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${excellent_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Excellent\n          </div>\n        </div>\n        \n        <!-- STRONG MATCHES - Blue theme -->\n        <div style=\"padding: 16px 8px; background: ${strong_count > 0 ? '#eff6ff' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${strong_count > 0 ? '#3b82f6' : '#e5e7eb'};\">\n          <div style=\"color: #3b82f6; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${strong_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Strong\n          </div>\n        </div>\n        \n        <!-- CONSIDER MATCHES - Amber theme -->\n        <div style=\"padding: 16px 8px; background: ${consider_count > 0 ? '#fffbeb' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${consider_count > 0 ? '#f59e0b' : '#e5e7eb'};\">\n          <div style=\"color: #f59e0b; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${consider_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Consider\n          </div>\n        </div>\n        \n        <!-- TOTAL JOBS - Gray theme -->\n        <div style=\"padding: 16px 8px; background: #f9fafb; border-radius: 8px; border: 2px solid #d1d5db;\">\n          <div style=\"color: #374151; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${total_jobs}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Total\n          </div>\n        </div>\n        \n      </div>\n      \n      <!-- Conditional highlight banner for excellent matches -->\n      ${excellent_count > 0 ? `\n      <div style=\"margin-top: 16px; padding: 12px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;\">\n        <p style=\"margin: 0; color: #065f46; font-size: 13px; font-weight: 600;\">\n          âš¡ You have ${excellent_count} excellent match${excellent_count !== 1 ? 'es' : ''} today!\n        </p>\n      </div>\n      ` : ''}\n      \n    </div>\n    \n    <!-- ================================================ -->\n    <!-- JOB CARDS SECTION -->\n    <!-- All formatted job cards inserted here -->\n    <!-- ================================================ -->\n    <div style=\"margin-bottom: 24px;\">\n      ${job_cards_html}\n    </div>\n    \n    <!-- ================================================ -->\n    <!-- EMAIL FOOTER -->\n    <!-- System information and workflow tracking -->\n    <!-- ================================================ -->\n    <div style=\"background: #ffffff; padding: 20px; border-radius: 8px; text-align: center; font-size: 13px; color: #6b7280; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\">\n      <p style=\"margin: 0 0 8px 0; font-weight: 600; color: #374151;\">\n        ğŸ“¬ Automated Job Monitoring System\n      </p>\n      <p style=\"margin: 0 0 4px 0;\">\n        Workflow Run ID: <code style=\"background: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-family: monospace;\">#${workflow_run_id}</code>\n      </p>\n      <p style=\"margin: 0; font-size: 12px;\">\n        Questions? Reply to this email or check your workflow logs.\n      </p>\n    </div>\n    \n    <!-- Spacer for email clients -->\n    <div style=\"height: 40px;\"></div>\n    \n  </div>\n  \n</body>\n</html>\n`;\n\n// ============================================================================\n// EMAIL DESIGN PRINCIPLES\n// ============================================================================\n\n// 1. INLINE STYLES:\n// - Email clients strip <style> tags and external CSS\n// - All styling must be inline style=\"...\" attributes\n// - Verbose but necessary for email compatibility\n\n// 2. TABLE-FREE LAYOUT:\n// - Modern approach using divs with inline-block\n// - Grid layout for statistics (fallback to stacked on mobile)\n// - More maintainable than traditional table-based email layouts\n\n// 3. COLOR CODING:\n// - Green: Excellent matches (positive, go)\n// - Blue: Strong matches (confident, professional)\n// - Amber: Consider (caution, review needed)\n// - Gray: Neutral statistics\n\n// 4. PROGRESSIVE ENHANCEMENT:\n// - Base layout works in all email clients\n// - Enhanced features (gradients, shadows) degrade gracefully\n// - Text remains readable even if styling breaks\n\n// 5. MOBILE RESPONSIVE:\n// - 700px max width for desktop readability\n// - Grid columns stack on narrow screens\n// - Touch-friendly sizing (minimum 44px tap targets)\n\n// ============================================================================\n// CONDITIONAL CONTENT\n// ============================================================================\n\n// Excellent matches highlight:\n// ${excellent_count > 0 ? `...` : ''}\n// - Only shows if there are excellent matches\n// - Creates excitement and urgency\n// - Empty string if no excellent matches\n\n// Category styling:\n// background: ${excellent_count > 0 ? '#f0fdf4' : '#f9fafb'}\n// - Active: Colored background (light green)\n// - Inactive: Gray background\n// - Visual feedback on which categories have jobs\n\n// ============================================================================\n// OUTPUT STRUCTURE\n// Return email metadata and HTML body\n// ============================================================================\n\nreturn [{\n  json: {\n    // === EMAIL METADATA ===\n    subject: subject,\n    // \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n    \n    html_body: emailHtml,\n    // Complete HTML email (10-20KB typical)\n    \n    // === SUMMARY STATISTICS (for logging) ===\n    total_jobs: total_jobs,\n    excellent_count: excellent_count,\n    \n    // === WORKFLOW TRACKING ===\n    workflow_run_id: workflow_run_id,\n    \n    // === TIMESTAMP ===\n    generated_at: new Date().toISOString()\n    // When email was generated (for debugging)\n  }\n}];\n\n// WHAT GETS OUTPUT:\n// Single item with complete email ready to send:\n// {\n//   subject: \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\",\n//   html_body: \"<!DOCTYPE html><html>...\",\n//   total_jobs: 20,\n//   excellent_count: 3,\n//   workflow_run_id: 67890,\n//   generated_at: \"2025-12-29T14:30:00.000Z\"\n// }\n\n// WHY THIS ARCHITECTURE:\n// 1. SEPARATION OF CONCERNS:\n//    - Previous node: Data aggregation and sorting\n//    - This node: Presentation and formatting\n//    - Next node: Delivery mechanism (Gmail)\n//    \n// 2. TESTABILITY:\n//    - Can preview HTML by viewing node output\n//    - Can save HTML to file for browser testing\n//    - Can modify template without affecting data logic\n//    \n// 3. FLEXIBILITY:\n//    - Easy to A/B test different email designs\n//    - Can add/remove sections without breaking workflow\n//    - Template variables clearly marked with ${}\n\n// ALTERNATIVE EMAIL FORMATS (future enhancements):\n// 1. Plain text version:\n//    - For email clients that don't support HTML\n//    - Fallback for accessibility\n//    \n// 2. Different templates by job count:\n//    - Rich template for 10+ jobs\n//    - Compact template for 1-3 jobs\n//    \n// 3. Digest frequency variants:\n//    - Daily: All jobs from today\n//    - Weekly: Top 20 jobs from week\n//    - Instant: Single excellent match alert\n\n// EMAIL CLIENT COMPATIBILITY:\n// Tested with:\n// - Gmail (web, iOS, Android)\n// - Outlook (web, desktop)\n// - Apple Mail (macOS, iOS)\n// - Other modern email clients\n// \n// Known limitations:\n// - Some email clients strip CSS gradients\n// - Grid layout may not work in old Outlook versions\n// - Fallbacks ensure content remains readable\n\n// Next node: Send Jobs Email (Gmail delivery)\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        0
      ],
      "id": "71505efc-12fe-422e-bdad-3d6ecde84e5a",
      "name": "Build Email",
      "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  NODE 4: BUILD EMAIL (HTML EMAIL GENERATOR)  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  Purpose: Create professional, responsive HTML email with job digest\n  Input: Single aggregated item with statistics and combined HTML\n  Output: Complete email with dynamic subject line and formatted HTML body\n\n  Key features:\n  - Dynamic subject line based on job quality\n  - Professional HTML email template\n  - Responsive design for mobile/desktop\n  - Color-coded statistics (green/blue/amber/gray)\n  - Conditional content (highlight for excellent matches)\n  - Email client compatible (inline styles)\n\n  Next node: Send Jobs Email\n"
    },
    {
      "parameters": {
        "sendTo": "tcbeatie@gmail.com",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        832,
        0
      ],
      "id": "d8c80283-2335-438e-b1c7-ab9d66db7148",
      "name": "Send Jobs Email",
      "webhookId": "63d8731d-d015-42b8-a6d0-c3ce82388adb",
      "credentials": {
        "gmailOAuth2": {
          "id": "WFKSlQYcJlpiAeDN",
          "name": "Personal Gmail"
        }
      },
      "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  NODE 5: SEND EMAIL VIA GMAIL (FINAL DELIVERY)  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  Sends the formatted job digest email via Gmail API.\n\n  When this completes successfully, the job\n  monitoring system has finished its daily run\n  and the user receives their job digest in their inbox.\n\n  Next: [No next node - workflow complete]\n        User receives email and reviews jobs\n"
    }
  ],
  "pinData": {},
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Load Email Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Email Queue": {
      "main": [
        [
          {
            "node": "Aggregate and Sort Jobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate and Sort Jobs": {
      "main": [
        [
          {
            "node": "Build Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email": {
      "main": [
        [
          {
            "node": "Send Jobs Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "871959d6-52a8-493e-a71c-99e28e7552ff",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b50b11e8b95a97f785a59928b1142bfe5660398bf6359dbc9cca38ca2424c956"
  },
  "id": "rP3O63GIhuk46JSI",
  "tags": []
}