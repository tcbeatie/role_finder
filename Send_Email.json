{
  "name": "Send Email - FULLY DOCUMENTED",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1936,
        736
      ],
      "id": "6177d10d-1f5f-49da-bfc3-e19b8964696b",
      "name": "When clicking 'Execute workflow'",
      "COMMENT": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nNODE 1: WORKFLOW TRIGGER (EMAIL WORKFLOW ENTRY POINT)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nThis is the entry point for the Email workflow, the THIRD workflow in the\njob monitoring system.\n\nHow this workflow gets triggered:\n1. PRODUCTION: Called as sub-workflow from \"Loop Companies\" workflow\n   - Parent's \"Workflow Summary\" node calls this workflow\n   - Passes workflow_run_id for querying jobs\n   - Happens AFTER all companies and jobs processed\n   \n2. TESTING: Manual execution with test data\n   - Click \"Execute workflow\" button in n8n UI\n   - Must provide workflow_run_id via pin data or input\n   - Useful for testing email formatting without running full job scan\n\nWhat data arrives here:\nWhen called from parent workflow, receives:\n- workflow_run_id: Parent workflow's execution ID\n  - Example: 67890\n  - Used to query email_queue table\n  - Links to all jobs processed in parent workflow run\n  \n- companies_processed: Summary count (optional)\n  - Example: 40\n  - For logging/debugging\n  \n- query_timestamp: When parent completed (optional)\n  - Example: \"2025-12-29T14:30:00.000Z\"\n  - For audit trail\n\nArchitectural context:\nThis is the FINAL workflow in the three-workflow pipeline:\n\nWorkflow 1 (Loop Companies):\n- Orchestrates company-by-company processing\n- For each company, calls Workflow 2\n- When all companies complete, triggers Workflow 3 (THIS ONE)\n\nWorkflow 2 (Loop Jobs):\n- Processes individual jobs with AI evaluation\n- Saves results to email_queue table\n- Returns control to Workflow 1\n\nWorkflow 3 (Send Email - THIS WORKFLOW):\n- Queries email_queue for all jobs from workflow run\n- Aggregates and sorts by AI score\n- Generates professional HTML email\n- Sends via Gmail\n- Completes the entire pipeline\n\nData flow summary:\nâ”Œâ”€ Loop Companies (Workflow 1)\nâ”‚  â”œâ”€ Company 1: Anthropic\nâ”‚  â”‚  â””â”€ Loop Jobs (Workflow 2): 8 jobs â†’ email_queue\nâ”‚  â”œâ”€ Company 2: OpenAI\nâ”‚  â”‚  â””â”€ Loop Jobs (Workflow 2): 5 jobs â†’ email_queue\nâ”‚  â””â”€ All companies done\nâ”‚     â””â”€ Workflow Summary: workflow_run_id = 67890\nâ”‚        â””â”€ Send Email (Workflow 3 - THIS ONE)\nâ”‚           â”œâ”€ Query: WHERE workflow_run_id = 67890\nâ”‚           â”œâ”€ Get: All 13 jobs across all companies\nâ”‚           â”œâ”€ Sort: By overall_score DESC\nâ”‚           â”œâ”€ Format: Create HTML email\nâ”‚           â””â”€ Send: Single email with all jobs\n\nCritical note on workflow_run_id:\nThe workflow_run_id is THE KEY that ties everything together:\n- Set by Loop Companies workflow (its execution ID)\n- Passed to Loop Jobs via _context_workflow_run_id\n- Stored in email_queue table with every job\n- Passed to this workflow for querying\n- Result: All jobs from entire workflow run in single query\n\nWhy separate email workflow?\n1. SEPARATION OF CONCERNS:\n   - Job discovery: Loop Companies\n   - Job evaluation: Loop Jobs\n   - Email delivery: Send Email (this)\n   \n2. INDEPENDENT TESTING:\n   - Can test email formatting without running job scan\n   - Can regenerate email from existing queue data\n   - Can A/B test different email designs\n   \n3. FLEXIBILITY:\n   - Could send multiple emails (hourly, daily, weekly)\n   - Could filter by recommendation (only excellent matches)\n   - Could send to different recipients\n   - Could use different email templates\n   \n4. FAULT TOLERANCE:\n   - If email fails, can retry without re-running job evaluation\n   - Queue data persists in database\n   - Can manually trigger email send\n\nTesting this workflow manually:\nTo test without running full pipeline:\n1. Find a recent workflow_run_id from email_queue table\n2. Add pin data to Manual Trigger node:\n   { \"workflow_run_id\": 67890 }\n3. Click \"Execute workflow\"\n4. Email generated from existing queue data\n\nProduction flow:\nLoop Companies (Done branch) â†’ Workflow Summary â†’ Call 'Send Email' â†’\nThis workflow receives workflow_run_id â†’ Queries and sends email\n\nNext node: Load Email Queue\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "FcYe2cOsjo5J6Pr5",
          "mode": "list",
          "cachedResultName": "email queue test",
          "cachedResultUrl": "/projects/MIniGOtG65wFTuKC/datatables/FcYe2cOsjo5J6Pr5"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "workflow_run_id",
              "keyValue": "={{ $json.workflow_run_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        -1696,
        736
      ],
      "id": "267d2a8c-69c9-4965-b026-9edfb9032688",
      "name": "Load Email Queue",
      "COMMENT": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nNODE 2: LOAD EMAIL QUEUE FROM DATABASE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nQueries the email_queue table to retrieve all jobs processed in the\ncurrent workflow run.\n\nWhat this node does:\n- Connects to n8n data table: \"email queue test\" (Table ID: FcYe2cOsjo5J6Pr5)\n- Filters by workflow_run_id from parent workflow\n- Returns ALL jobs across ALL companies from this workflow run\n- Each row is one job with complete HTML card and metadata\n\nDatabase table: email_queue\n\nColumns in table:\n1. workflow_run_id (number):\n   - Primary filter field\n   - Groups all jobs from single workflow run\n   - Example: 67890\n   \n2. recommendation (string):\n   - AI's recommendation category\n   - Values: EXCELLENT_MATCH, GOOD_MATCH, CONSIDER, POOR_FIT, REJECT\n   - Used for filtering and grouping\n   \n3. overall_score (number):\n   - AI's numeric score (1-10)\n   - Primary sort field\n   - Higher = better match\n   \n4. html_card (string):\n   - Complete, formatted HTML job card\n   - Self-contained, ready to insert in email\n   - Generated by Loop Jobs workflow\n   \n5. job_id (string):\n   - Unique identifier\n   - Links back to raw jobs table\n   \n6. company_name (string):\n   - Company posting the job\n   - Used for grouping in email\n   \n7. job_title (string):\n   - Job title for reference\n\nQuery filter explained:\n{{ $json.workflow_run_id }}\n- Reads workflow_run_id from input (Manual Trigger or parent workflow)\n- Example: WHERE workflow_run_id = 67890\n- Returns only jobs from this specific workflow run\n\nWhy filter by workflow_run_id?\n- Email queue accumulates jobs across MULTIPLE workflow runs over time\n- We only want jobs from TODAY'S run (or current run)\n- Each daily run gets unique workflow_run_id\n- Filter ensures we only email today's newly found jobs\n\nExample query result:\nIf today's workflow processed:\n- Company 1 (Anthropic): 8 jobs\n- Company 2 (OpenAI): 5 jobs  \n- Company 3 (Google): 7 jobs\n\nThis query returns: 20 jobs total (8 + 5 + 7)\n\nEach returned item looks like:\n{\n  workflow_run_id: 67890,\n  recommendation: \"EXCELLENT_MATCH\",\n  overall_score: 9,\n  html_card: \"<div style=\\\"...\\\">...</div>\",\n  job_id: \"12345\",\n  company_name: \"Anthropic\",\n  job_title: \"Senior Technical Product Manager\"\n}\n\nAutomatic iteration:\nn8n AUTOMATICALLY creates separate items for each database row.\nIf query returns 20 jobs, downstream nodes receive 20 items.\n\nNo results scenario:\nIf workflow_run_id not found in table:\n- Query returns 0 rows\n- Downstream nodes receive empty array\n- Could add error handling for this case\n- Might indicate:\n  - No jobs found during job scan\n  - workflow_run_id mismatch\n  - Database connectivity issue\n\nData persistence:\nEmail queue table persists data permanently (until manually cleared).\nBenefits:\n- Can regenerate emails from past runs\n- Historical record of job discoveries\n- A/B test email formats on same data\n- Retry email delivery if failed\n\nExample queries for different use cases:\n\n1. Today's jobs (current):\n   WHERE workflow_run_id = 67890\n   \n2. Only excellent matches:\n   WHERE workflow_run_id = 67890 AND recommendation = 'EXCELLENT_MATCH'\n   \n3. High scorers only:\n   WHERE workflow_run_id = 67890 AND overall_score >= 8\n   \n4. Specific company:\n   WHERE workflow_run_id = 67890 AND company_name = 'Anthropic'\n\nProduction considerations:\n1. INDEX: Create index on workflow_run_id for fast queries\n2. CLEANUP: Schedule job to delete old queue entries (e.g., >30 days)\n3. MONITORING: Alert if query returns 0 rows unexpectedly\n4. BACKUP: Regular database backups of queue table\n\nData flow to next node:\nAll 20 job items â†’ Aggregate and Sort Jobs\nNext node receives array of job objects, each with html_card field\n\nNext node: Aggregate and Sort Jobs\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NODE 3: AGGREGATE AND SORT JOBS\n// Purpose: Organize jobs by score and category for optimal email presentation\n// ============================================================================\n\n// STEP 1: Get all jobs from database query\n// $input.all() returns array of ALL items from Load Email Queue node\nconst allJobs = $input.all();\n// Example: 20 items (jobs) from email_queue table\n\n// ============================================================================\n// CATEGORIZATION\n// Group jobs by AI recommendation for statistics\n// ============================================================================\n\n// EXCELLENT_MATCH: Top-tier jobs - perfect fit across all dimensions\nconst excellentMatches = allJobs.filter(job => job.json.recommendation === 'EXCELLENT_MATCH');\n// Example: 3 jobs\n\n// GOOD_MATCH: Strong candidates - good fit with minor gaps\n// NOTE: Original code uses 'STRONG_MATCH' but AI returns 'GOOD_MATCH'\n// Keeping both for compatibility\nconst strongMatches = allJobs.filter(job => \n  job.json.recommendation === 'STRONG_MATCH' || \n  job.json.recommendation === 'GOOD_MATCH'\n);\n// Example: 8 jobs\n\n// CONSIDER: Possible matches - worth reviewing despite gaps\nconst considerJobs = allJobs.filter(job => job.json.recommendation === 'CONSIDER');\n// Example: 6 jobs\n\n// POOR_FIT: Not recommended - significant mismatches\nconst poorFits = allJobs.filter(job => job.json.recommendation === 'POOR_FIT');\n// Example: 3 jobs\n\n// ============================================================================\n// SORTING\n// Primary sort: overall_score descending (best jobs first)\n// ============================================================================\n\nconst sortedJobs = allJobs.sort((a, b) => \n  b.json.overall_score - a.json.overall_score\n);\n// Result: Jobs ordered 10 â†’ 9 â†’ 9 â†’ 8 â†’ 7 â†’ ...\n// Best matches appear at top of email\n\n// Alternative sorting strategies (not currently used):\n// 1. Sort by recommendation then score:\n//    - All EXCELLENT_MATCH first, then GOOD_MATCH, etc.\n//    - Within each category, sort by score\n// 2. Sort by company then score:\n//    - Group by company_name\n//    - Within each company, sort by score\n// 3. Sort by date_posted then score:\n//    - Newest jobs first\n//    - Within same date, sort by score\n\n// ============================================================================\n// HTML CARD CONCATENATION\n// Combine individual job cards into single HTML block\n// ============================================================================\n\nconst jobCardsHtml = sortedJobs\n  .map(job => job.json.html_card)  // Extract html_card field from each job\n  .join('\\n<div style=\"margin: 20px 0;\"></div>\\n');  // Add spacer between cards\n\n// WHAT THIS DOES:\n// Takes: Array of 20 job objects with html_card fields\n// \n// Step 1 - .map(): Extract just the HTML cards\n// [\n//   \"<div style=\\\"...\\\">Job 1 card HTML</div>\",\n//   \"<div style=\\\"...\\\">Job 2 card HTML</div>\",\n//   ...\n// ]\n// \n// Step 2 - .join(): Concatenate with spacer\n// \"<div>Job 1</div>\\n<div style=\\\"margin: 20px 0;\\\"></div>\\n<div>Job 2</div>...\"\n// \n// Result: Single string with all job cards and visual spacing\n\n// WHY ADD SPACERS?\n// - Visual separation between job cards\n// - 20px vertical margin provides breathing room\n// - Prevents cards from looking cramped\n// - Improves email readability\n\n// ============================================================================\n// VALIDATION CHECK (Optional - could add)\n// ============================================================================\n\n// Could add validation:\n// if (allJobs.length === 0) {\n//   throw new Error('No jobs found in email queue for this workflow_run_id');\n// }\n\n// ============================================================================\n// OUTPUT STRUCTURE\n// Create single aggregated object with statistics and HTML\n// ============================================================================\n\nreturn [{\n  json: {\n    // === SUMMARY COUNTS ===\n    // These drive the email header statistics and subject line\n    total_jobs: allJobs.length,  // 20\n    excellent_count: excellentMatches.length,  // 3\n    strong_count: strongMatches.length,  // 8\n    consider_count: considerJobs.length,  // 6\n    poor_count: poorFits.length,  // 3\n    \n    // === COMPLETE HTML CONTENT ===\n    // All job cards concatenated with spacers, sorted by score\n    job_cards_html: jobCardsHtml,\n    // ~100KB of HTML for 20 jobs\n    \n    // === WORKFLOW TRACKING ===\n    // Preserve workflow_run_id for email footer and debugging\n    workflow_run_id: allJobs[0].json.workflow_run_id\n    // Safe to access [0] because we know we have jobs from query\n  }\n}];\n\n// WHAT GETS OUTPUT:\n// Single item (not 20) with aggregated data:\n// {\n//   total_jobs: 20,\n//   excellent_count: 3,\n//   strong_count: 8,\n//   consider_count: 6,\n//   poor_count: 3,\n//   job_cards_html: \"<div>...</div><spacer><div>...</div>...\",\n//   workflow_run_id: 67890\n// }\n\n// WHY CONSOLIDATE TO SINGLE ITEM?\n// Before this node:\n// - Load Email Queue returns 20 separate items (one per job)\n// - Each item is a complete job object\n// \n// After this node:\n// - Returns 1 single item with aggregated data\n// - Includes counts and combined HTML\n// \n// Benefits:\n// 1. Simplifies email generation (next node)\n// 2. Counts already calculated\n// 3. HTML already sorted and combined\n// 4. Build Email node just inserts values into template\n\n// EXAMPLE EMAIL SUBJECT LINE (next node generates):\n// \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n// These numbers come from excellent_count, strong_count, total_jobs\n\n// EXAMPLE EMAIL BODY (next node generates):\n// [Header with summary stats]\n// [Job card 1 - score 10]\n// <spacer>\n// [Job card 2 - score 9]\n// <spacer>\n// [Job card 3 - score 9]\n// ...\n// [Footer]\n\n// POTENTIAL ENHANCEMENTS:\n// Could add more sophisticated sorting:\n// 1. Group by company:\n//    const jobsByCompany = {};\n//    allJobs.forEach(job => {\n//      const company = job.json.company_name;\n//      if (!jobsByCompany[company]) jobsByCompany[company] = [];\n//      jobsByCompany[company].push(job);\n//    });\n//    \n// 2. Filter by score threshold:\n//    const topJobs = sortedJobs.filter(job => job.json.overall_score >= 7);\n//    \n// 3. Add company counts:\n//    const companies = [...new Set(allJobs.map(j => j.json.company_name))];\n//    companies_count: companies.length\n\n// ARCHITECTURAL NOTE:\n// This node transforms:\n// - Many items (job objects) â†’ One item (aggregated summary)\n// - Individual job cards â†’ Combined HTML string\n// - Raw data â†’ Presentation-ready data\n// \n// This pattern is common in data aggregation workflows:\n// Query â†’ Individual results â†’ Aggregate â†’ Single summary\n\n// Next node: Build Email\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1424,
        736
      ],
      "id": "6deada27-d2c2-4e7c-baa6-246db0036513",
      "name": "Aggregate and Sort Jobs"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NODE 4: BUILD EMAIL (HTML EMAIL GENERATOR)\n// Purpose: Create professional, responsive HTML email with job digest\n// ============================================================================\n\n// STEP 1: Get aggregated data from previous node\n// Previous node consolidated 20 jobs into single item with statistics\nconst data = $input.first().json;\n// .first() gets the single aggregated item\n// .json extracts the data object\n\n// STEP 2: Destructure all the statistics and content\nconst {\n  total_jobs,           // 20 - Total jobs in this digest\n  excellent_count,      // 3 - Excellent matches\n  strong_count,         // 8 - Good/Strong matches\n  consider_count,       // 6 - Consider reviewing\n  poor_count,          // 3 - Poor fits\n  job_cards_html,      // Combined HTML of all job cards\n  workflow_run_id      // 67890 - Workflow tracking ID\n} = data;\n\n// ============================================================================\n// DYNAMIC SUBJECT LINE GENERATION\n// Creates attention-grabbing subject based on job quality distribution\n// ============================================================================\n\n// Build subject line parts dynamically\nlet subjectParts = [];\n\n// Prioritize excellent matches\nif (excellent_count > 0) {\n  subjectParts.push(`${excellent_count} Excellent Match${excellent_count !== 1 ? 'es' : ''}`);\n  // Examples: \"1 Excellent Match\", \"3 Excellent Matches\"\n}\n\n// Add strong matches if present\nif (strong_count > 0) {\n  subjectParts.push(`${strong_count} Strong`);\n  // Examples: \"8 Strong\"\n}\n\n// Only mention \"consider\" if no excellent or strong matches\nif (consider_count > 0 && excellent_count === 0 && strong_count === 0) {\n  subjectParts.push(`${consider_count} to Consider`);\n  // Only shown if digest is entirely \"consider\" level jobs\n}\n\n// Assemble final subject line\nconst subject = subjectParts.length > 0\n  ? `ğŸ¯ ${subjectParts.join(', ')} â€¢ ${total_jobs} Total Jobs`\n  : `ğŸ“Š ${total_jobs} New Job${total_jobs !== 1 ? 's' : ''} to Review`;\n\n// Example subject lines:\n// - \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\" (good day)\n// - \"ğŸ¯ 2 Excellent Matches â€¢ 5 Total Jobs\" (fewer jobs, high quality)\n// - \"ğŸ“Š 3 New Jobs to Review\" (no excellent/strong matches)\n// - \"ğŸ“Š 1 New Job to Review\" (singular grammar)\n\n// WHY DYNAMIC SUBJECTS?\n// - Immediate attention to excellent matches\n// - User can triage email priority from inbox\n// - Excitement for good days (\"3 Excellent Matches!\")\n// - Professional tone for normal days\n\n// ============================================================================\n// DATE FORMATTING\n// Display current date in email header\n// ============================================================================\n\nconst today = new Date();\nconst formattedDate = today.toLocaleDateString('en-US', { \n  weekday: 'long',      // \"Monday\"\n  year: 'numeric',      // \"2025\"\n  month: 'long',        // \"December\"\n  day: 'numeric'        // \"29\"\n});\n// Result: \"Monday, December 29, 2025\"\n\n// ============================================================================\n// HTML EMAIL TEMPLATE\n// Professional, responsive design optimized for email clients\n// ============================================================================\n\nconst emailHtml = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Daily Job Digest</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\">\n  \n  <!-- Email Container: 700px max width for readability -->\n  <div style=\"max-width: 700px; margin: 0 auto; padding: 20px;\">\n    \n    <!-- ================================================ -->\n    <!-- EMAIL HEADER -->\n    <!-- Purple gradient banner with title and date -->\n    <!-- ================================================ -->\n    <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 24px; border-radius: 12px 12px 0 0; margin-bottom: 0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n      <h1 style=\"margin: 0 0 8px 0; color: #ffffff; font-size: 28px; font-weight: 700; letter-spacing: -0.5px;\">\n        ğŸ¯ Your Daily Job Digest\n      </h1>\n      <p style=\"margin: 0; color: rgba(255, 255, 255, 0.9); font-size: 15px;\">\n        ${formattedDate}\n      </p>\n    </div>\n    \n    <!-- ================================================ -->\n    <!-- SUMMARY STATISTICS CARD -->\n    <!-- Four-column grid showing job counts by category -->\n    <!-- ================================================ -->\n    <div style=\"background: #ffffff; padding: 24px; border-radius: 0 0 12px 12px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n      \n      <!-- Four-column responsive grid -->\n      <div style=\"display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;\">\n        \n        <!-- EXCELLENT MATCHES - Green theme -->\n        <div style=\"padding: 16px 8px; background: ${excellent_count > 0 ? '#f0fdf4' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${excellent_count > 0 ? '#10b981' : '#e5e7eb'};\">\n          <div style=\"color: #10b981; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${excellent_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Excellent\n          </div>\n        </div>\n        \n        <!-- STRONG MATCHES - Blue theme -->\n        <div style=\"padding: 16px 8px; background: ${strong_count > 0 ? '#eff6ff' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${strong_count > 0 ? '#3b82f6' : '#e5e7eb'};\">\n          <div style=\"color: #3b82f6; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${strong_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Strong\n          </div>\n        </div>\n        \n        <!-- CONSIDER MATCHES - Amber theme -->\n        <div style=\"padding: 16px 8px; background: ${consider_count > 0 ? '#fffbeb' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${consider_count > 0 ? '#f59e0b' : '#e5e7eb'};\">\n          <div style=\"color: #f59e0b; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${consider_count}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Consider\n          </div>\n        </div>\n        \n        <!-- TOTAL JOBS - Gray theme -->\n        <div style=\"padding: 16px 8px; background: #f9fafb; border-radius: 8px; border: 2px solid #d1d5db;\">\n          <div style=\"color: #374151; font-weight: 700; font-size: 24px; margin-bottom: 4px;\">\n            ${total_jobs}\n          </div>\n          <div style=\"color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;\">\n            Total\n          </div>\n        </div>\n        \n      </div>\n      \n      <!-- Conditional highlight banner for excellent matches -->\n      ${excellent_count > 0 ? `\n      <div style=\"margin-top: 16px; padding: 12px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;\">\n        <p style=\"margin: 0; color: #065f46; font-size: 13px; font-weight: 600;\">\n          âš¡ You have ${excellent_count} excellent match${excellent_count !== 1 ? 'es' : ''} today!\n        </p>\n      </div>\n      ` : ''}\n      \n    </div>\n    \n    <!-- ================================================ -->\n    <!-- JOB CARDS SECTION -->\n    <!-- All formatted job cards inserted here -->\n    <!-- ================================================ -->\n    <div style=\"margin-bottom: 24px;\">\n      ${job_cards_html}\n    </div>\n    \n    <!-- ================================================ -->\n    <!-- EMAIL FOOTER -->\n    <!-- System information and workflow tracking -->\n    <!-- ================================================ -->\n    <div style=\"background: #ffffff; padding: 20px; border-radius: 8px; text-align: center; font-size: 13px; color: #6b7280; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\">\n      <p style=\"margin: 0 0 8px 0; font-weight: 600; color: #374151;\">\n        ğŸ“¬ Automated Job Monitoring System\n      </p>\n      <p style=\"margin: 0 0 4px 0;\">\n        Workflow Run ID: <code style=\"background: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-family: monospace;\">#${workflow_run_id}</code>\n      </p>\n      <p style=\"margin: 0; font-size: 12px;\">\n        Questions? Reply to this email or check your workflow logs.\n      </p>\n    </div>\n    \n    <!-- Spacer for email clients -->\n    <div style=\"height: 40px;\"></div>\n    \n  </div>\n  \n</body>\n</html>\n`;\n\n// ============================================================================\n// EMAIL DESIGN PRINCIPLES\n// ============================================================================\n\n// 1. INLINE STYLES:\n// - Email clients strip <style> tags and external CSS\n// - All styling must be inline style=\"...\" attributes\n// - Verbose but necessary for email compatibility\n\n// 2. TABLE-FREE LAYOUT:\n// - Modern approach using divs with inline-block\n// - Grid layout for statistics (fallback to stacked on mobile)\n// - More maintainable than traditional table-based email layouts\n\n// 3. COLOR CODING:\n// - Green: Excellent matches (positive, go)\n// - Blue: Strong matches (confident, professional)\n// - Amber: Consider (caution, review needed)\n// - Gray: Neutral statistics\n\n// 4. PROGRESSIVE ENHANCEMENT:\n// - Base layout works in all email clients\n// - Enhanced features (gradients, shadows) degrade gracefully\n// - Text remains readable even if styling breaks\n\n// 5. MOBILE RESPONSIVE:\n// - 700px max width for desktop readability\n// - Grid columns stack on narrow screens\n// - Touch-friendly sizing (minimum 44px tap targets)\n\n// ============================================================================\n// CONDITIONAL CONTENT\n// ============================================================================\n\n// Excellent matches highlight:\n// ${excellent_count > 0 ? `...` : ''}\n// - Only shows if there are excellent matches\n// - Creates excitement and urgency\n// - Empty string if no excellent matches\n\n// Category styling:\n// background: ${excellent_count > 0 ? '#f0fdf4' : '#f9fafb'}\n// - Active: Colored background (light green)\n// - Inactive: Gray background\n// - Visual feedback on which categories have jobs\n\n// ============================================================================\n// OUTPUT STRUCTURE\n// Return email metadata and HTML body\n// ============================================================================\n\nreturn [{\n  json: {\n    // === EMAIL METADATA ===\n    subject: subject,\n    // \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n    \n    html_body: emailHtml,\n    // Complete HTML email (10-20KB typical)\n    \n    // === SUMMARY STATISTICS (for logging) ===\n    total_jobs: total_jobs,\n    excellent_count: excellent_count,\n    \n    // === WORKFLOW TRACKING ===\n    workflow_run_id: workflow_run_id,\n    \n    // === TIMESTAMP ===\n    generated_at: new Date().toISOString()\n    // When email was generated (for debugging)\n  }\n}];\n\n// WHAT GETS OUTPUT:\n// Single item with complete email ready to send:\n// {\n//   subject: \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\",\n//   html_body: \"<!DOCTYPE html><html>...\",\n//   total_jobs: 20,\n//   excellent_count: 3,\n//   workflow_run_id: 67890,\n//   generated_at: \"2025-12-29T14:30:00.000Z\"\n// }\n\n// WHY THIS ARCHITECTURE:\n// 1. SEPARATION OF CONCERNS:\n//    - Previous node: Data aggregation and sorting\n//    - This node: Presentation and formatting\n//    - Next node: Delivery mechanism (Gmail)\n//    \n// 2. TESTABILITY:\n//    - Can preview HTML by viewing node output\n//    - Can save HTML to file for browser testing\n//    - Can modify template without affecting data logic\n//    \n// 3. FLEXIBILITY:\n//    - Easy to A/B test different email designs\n//    - Can add/remove sections without breaking workflow\n//    - Template variables clearly marked with ${}\n\n// ALTERNATIVE EMAIL FORMATS (future enhancements):\n// 1. Plain text version:\n//    - For email clients that don't support HTML\n//    - Fallback for accessibility\n//    \n// 2. Different templates by job count:\n//    - Rich template for 10+ jobs\n//    - Compact template for 1-3 jobs\n//    \n// 3. Digest frequency variants:\n//    - Daily: All jobs from today\n//    - Weekly: Top 20 jobs from week\n//    - Instant: Single excellent match alert\n\n// EMAIL CLIENT COMPATIBILITY:\n// Tested with:\n// - Gmail (web, iOS, Android)\n// - Outlook (web, desktop)\n// - Apple Mail (macOS, iOS)\n// - Other modern email clients\n// \n// Known limitations:\n// - Some email clients strip CSS gradients\n// - Grid layout may not work in old Outlook versions\n// - Fallbacks ensure content remains readable\n\n// Next node: Send Jobs Email (Gmail delivery)\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        736
      ],
      "id": "2845430b-6c08-4078-9662-253fb65d152b",
      "name": "Build Email"
    },
    {
      "parameters": {
        "sendTo": "tcbeatie@gmail.com",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        -1008,
        736
      ],
      "id": "dbbc05b2-fb40-46ac-863d-c9251401db26",
      "name": "Send Jobs Email",
      "COMMENT": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nNODE 5: SEND EMAIL VIA GMAIL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSends the formatted job digest email via Gmail API.\n\nWhat this node does:\n- Connects to Gmail API using OAuth2 authentication\n- Sends HTML email with dynamic subject line\n- Delivers job digest to configured recipient\n- Completes the entire job monitoring pipeline\n\nConfiguration:\n\nRecipient:\n- sendTo: tcbeatie@gmail.com\n- In production: Could be environment variable or database config\n- Could support multiple recipients (comma-separated)\n- Could use BCC for privacy\n\nSubject line:\n- ={{ $json.subject }}\n- Dynamic subject from Build Email node\n- Examples:\n  - \"ğŸ¯ 3 Excellent Matches, 8 Strong â€¢ 20 Total Jobs\"\n  - \"ğŸ“Š 5 New Jobs to Review\"\n\nMessage body:\n- ={{ $json.html_body }}\n- Complete HTML email from Build Email node\n- ~10-20KB typical size\n- Includes:\n  - Header with date\n  - Summary statistics\n  - All job cards sorted by score\n  - Footer with workflow tracking\n\nAuthentication:\n- Type: OAuth2 (gmailOAuth2)\n- Credential ID: tILo1Ec3yoL2nMI9\n- Account: Gmail account\n- Scopes: gmail.send\n- Securely stored in n8n credentials\n\nGmail API benefits:\n1. RELIABILITY: Direct API access, not SMTP\n2. TRACKING: Sent emails appear in Gmail Sent folder\n3. THREADING: Replies thread with original email\n4. SECURITY: OAuth2, no password storage\n5. DELIVERABILITY: High inbox placement rate\n\nEmail delivery flow:\n1. n8n calls Gmail API\n2. Gmail validates credentials\n3. Gmail processes HTML email\n4. Gmail delivers to recipient inbox\n5. Email appears in sender's Sent folder\n6. Node returns delivery confirmation\n\nDelivery confirmation:\nGmail API returns:\n{\n  id: \"18d4e2f1a2b3c4d5\",  // Gmail message ID\n  threadId: \"18d4e2f1a2b3c4d5\",  // Thread ID for replies\n  labelIds: [\"SENT\"]  // Confirms sent successfully\n}\n\nError handling:\nCommon failure scenarios:\n\n1. AUTHENTICATION ERROR:\n   - Credential expired or invalid\n   - Solution: Re-authenticate Gmail OAuth2\n   - n8n shows: \"Authentication failed\"\n\n2. RATE LIMITING:\n   - Gmail API: 100 emails/second, 10,000/day per user\n   - This workflow: 1 email/day (well under limit)\n   - If hit: Retry with exponential backoff\n\n3. INVALID RECIPIENT:\n   - Email address malformed or doesn't exist\n   - Solution: Validate email format\n   - Gmail returns: \"Invalid recipient\"\n\n4. MESSAGE TOO LARGE:\n   - Gmail limit: 25MB (this workflow ~20KB, safe)\n   - If exceeded: Split into multiple emails\n\n5. NETWORK FAILURE:\n   - Temporary connectivity issue\n   - Solution: n8n retry mechanism\n   - Check: workflow execution log\n\nProduction considerations:\n\n1. MONITORING:\n   - Alert if email fails to send\n   - Track delivery success rate\n   - Log message IDs for debugging\n\n2. RETRY LOGIC:\n   - n8n built-in retry on failure\n   - Configure: 3 retries, 1 minute apart\n   - Log failures for manual review\n\n3. RECIPIENT MANAGEMENT:\n   - Store email in database/config\n   - Support multiple recipients\n   - Allow per-user subscriptions\n   - Unsubscribe mechanism\n\n4. TESTING:\n   - Send to test email first\n   - Verify HTML rendering\n   - Check mobile display\n   - Test with different job counts\n\n5. COMPLIANCE:\n   - Add unsubscribe link (if multiple users)\n   - Include physical address (CAN-SPAM)\n   - Honor opt-out requests\n   - Privacy policy link\n\nAlternative delivery methods:\n\n1. SMTP:\n   - Direct SMTP connection\n   - More complex setup\n   - Lower deliverability\n   - Not recommended\n\n2. SendGrid/Mailgun:\n   - Third-party email service\n   - Better for high volume\n   - More features (templates, analytics)\n   - Additional cost\n\n3. Slack/Discord:\n   - Send to messaging platform instead\n   - Good for team notifications\n   - Different format required\n\n4. Multiple channels:\n   - Email + Slack notification\n   - Email for digest, Slack for urgent\n   - Could split based on job quality\n\nEmail format notes:\n\n1. HTML ONLY:\n   - Current: HTML body only\n   - Best practice: Include plain text fallback\n   - Some clients prefer/require plain text\n\n2. ATTACHMENTS:\n   - Not currently used\n   - Could attach CSV of jobs\n   - Could attach PDF report\n\n3. IMAGES:\n   - Current: Emoji text characters only\n   - Could use hosted images\n   - Trade-off: Slower load, tracking pixels\n\nWorkflow completion:\nWhen this node succeeds:\n1. Email delivered to inbox\n2. Workflow marked as successful\n3. All three workflows complete:\n   - Loop Companies: Job discovery\n   - Loop Jobs: AI evaluation\n   - Send Email: Delivery (THIS WORKFLOW)\n4. User receives daily digest\n5. System ready for tomorrow's run\n\nTiming:\nTypical email delivery: < 1 second\nTotal workflow time (all three workflows):\n- 40 companies Ã— 2 seconds = 80 seconds\n- 120 jobs Ã— 3 seconds = 360 seconds  \n- Email generation + send = 2 seconds\n- Total: ~7-8 minutes end-to-end\n\nSuccess metrics:\n- Email delivery rate: >99%\n- Average time to inbox: <5 seconds\n- User engagement: Open rate, click rate\n- Job application rate: Track conversions\n\nThis is the FINAL node in the entire three-workflow pipeline.\nWhen this completes, the job monitoring system has finished its daily run.\n\nNext: [No next node - workflow complete]\n       User receives email and reviews jobs\n       Tomorrow: Workflow runs again\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
      "webhookId": "cceea35e-2862-4f41-9f25-b6b6f40a3644",
      "credentials": {
        "gmailOAuth2": {
          "id": "tILo1Ec3yoL2nMI9",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking 'Execute workflow'": {
      "main": [
        [
          {
            "node": "Load Email Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Email Queue": {
      "main": [
        [
          {
            "node": "Aggregate and Sort Jobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate and Sort Jobs": {
      "main": [
        [
          {
            "node": "Build Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email": {
      "main": [
        [
          {
            "node": "Send Jobs Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3326bae0-31e2-450c-a66f-6f36ecbf99c3",
  "meta": {
    "instanceId": "7534cf3caceb89a410b24188fae76f3b891a0be6d8178ba8a99d892ed4a4777d"
  },
  "id": "CuqnnmI3RT3UrrDP",
  "tags": []
}
